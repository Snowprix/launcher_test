name: Pipeline de Noticias AutomÃ¡tico (ETL)

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '*.py' # Se activa si cambias cualquier python en la raÃ­z

jobs:
  orquestador-de-noticias:
    name: ðŸš€ Ejecutar Pipeline de Datos
    runs-on: ubuntu-latest
    timeout-minutes: 260
    permissions:
      contents: write
      
    steps:
    - name: ðŸ“¥ Clonar repositorio
      uses: actions/checkout@v4

    - name: ðŸ Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        # Sin cachÃ© para evitar el error anterior

    - name: ðŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install playwright requests google-generativeai
        playwright install chromium
        playwright install-deps

    # --- FASE 1: SCRAPER ---
    - name: ðŸ” Verificando credenciales
      run: |
        if [ ! -f login/twitter_cookies.json ]; then
          echo "âŒ ERROR: No se encontraron las cookies en login/"
          exit 1
        fi

    - name: ðŸ•·ï¸ Ejecutar Scraper
      id: run_scraper
      run: |
        echo "--- INICIANDO EXTRACCIÃ“N ---"
        python src/scraper/2do_plano.py
      env:
        DISPLAY: ":99"

    - name: ðŸ“Š Validar datos
      id: check_data
      run: |
        count=$(ls tuits/*.json 2>/dev/null | wc -l)
        if [ "$count" != "0" ]; then
          echo "âœ… Ã‰xito: Se encontraron $count tuits."
          echo "has_data=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Alerta: No hay datos nuevos."
          echo "has_data=false" >> $GITHUB_OUTPUT
        fi

    # --- FASE 2: IA ---
    - name: ðŸ§  Generar Noticias
      if: steps.check_data.outputs.has_data == 'true'
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "--- INICIANDO IA ---"
        python src/ai_processor/generator_news.py

    # --- FASE 3: GUARDAR ---
    - name: ðŸ’¾ Guardar en Git
      if: steps.check_data.outputs.has_data == 'true'
      run: |
        git config user.name 'News-Bot-AI'
        git config user.email 'bot@noreply.github.com'
        
        git add tuits/
        git add news/ || true
        
        if ! git diff --cached --quiet; then
          git commit -m "ðŸ¤– Noticias generadas [$(date +'%Y-%m-%d')]"
          git push
        else
          echo "â„¹ï¸ Sin cambios nuevos."
        fi

    - name: ðŸ§¹ Limpieza
      if: always()
      run: rm -f login/*.png 2>/dev/null || true
